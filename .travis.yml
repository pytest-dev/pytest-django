sudo: false
language: python
dist: trusty

jobs:
  fast_finish: true
  include:
    - stage: test
      python: 3.6
      env: TOXENV=py36-dj20-postgres

stages:
  - name: test
    if: tag IS NOT present
  - name: test_release
    if: tag IS present
  - name: release
    if: tag IS present

install:
  - pip install tox==3.3.0
  - |
    # Setup coverage tracking.
    if [[ "$SKIP_COVERAGE" != 1 ]]; then
      export PYTEST_ADDOPTS="--cov=$PWD --cov-append --cov-report="
      export _PYTESTDJANGO_TOX_EXTRA_DEPS='pytest-cov==2.6.0'
    fi

script:
  - tox

after_success:
  - |
    set -ex
    if [[ "$SKIP_COVERAGE" != 1 ]]; then
      pip install codecov

      coverage combine || true
      coverage xml
      coverage report -m

      codecov_flags=${TOXENV//./}
      codecov_flags=${codecov_flags//-/ }
      codecov --required -X search gcov pycov -f coverage.xml --flags $codecov_flags
    fi
    set +x
